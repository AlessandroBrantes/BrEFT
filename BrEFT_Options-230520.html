{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "d931daf2",
   "metadata": {},
   "source": [
    "BrEFT_Options-230508 -\n",
    "\n",
    "Objetivo do Algoritmo:\n",
    "\n",
    "Identificar opções com prêmios distorcidos entre diversos ativos, considerando que modelos de precificação de opções, como o Black-Scholes, podem usar dados aleatórios e períodos de volatilidade atípicos, levando a possíveis distorções e oportunidades de lucro.\n",
    "\n",
    "Coletar dados de opções e ativos subjacentes, incluindo preços, prêmios, datas de vencimento, preços de exercício e volatilidade implícita.\n",
    "Obter o preço atual do ativo subjacente e calcular a volatilidade histórica.\n",
    "Calcular a volatilidade implícita das opções.\n",
    "Filtrar opções com base no intervalo de tempo até a data de vencimento e no símbolo do ativo subjacente.\n",
    "Analisar os dados históricos de preços do ativo subjacente e das opções para identificar padrões e tendências que podem indicar distorções.\n",
    "Desenvolver um modelo de aprendizado de máquina baseado em redes neurais para prever a distorção do prêmio da opção.\n",
    "Avaliar e ajustar o modelo usando conjuntos de treinamento, validação e teste.\n",
    "Implementar o modelo em um ambiente de negociação real e monitorar seu desempenho.\n",
    "\n",
    "Sumário de Células:\n",
    "\n",
    "Célula 01 - Importando bibliotecas necessárias;\n",
    "Célula 02 - Parâmetros e hiperparâmetros ajustáveis;\n",
    "Célula 03 - Obtendo e salvando os dados dos ativos subjacentes e das opções;\n",
    "Célula 04 - Processamento, limpeza e divisão dos dados;\n",
    "Célula 05 - Calculando a volatilidade histórica e implícita e filtrando opções;\n",
    "Célula 06 - Análise exploratória e identificação de padrões e tendências;\n",
    "Célula 07 - Construção do modelo de aprendizado de máquina;\n",
    "Célula 08 - Treinamento e validação do modelo de aprendizado de máquina;\n",
    "Célula 09 - Avaliação do desempenho do modelo de aprendizado de máquina;\n",
    "Célula 10 - Implementação do modelo em um ambiente de negociação real e monitoramento de seu desempenho."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "8709ae42",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Importando bibliotecas necessárias\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns\n",
    "import datetime\n",
    "import time\n",
    "\n",
    "# Bibliotecas de aprendizado de máquina\n",
    "import tensorflow as tf\n",
    "from tensorflow.keras.models import Sequential\n",
    "from tensorflow.keras.layers import Dense, Dropout\n",
    "from tensorflow.keras.optimizers import Adam\n",
    "from tensorflow.keras.callbacks import EarlyStopping\n",
    "from sklearn.preprocessing import StandardScaler\n",
    "from sklearn.model_selection import train_test_split\n",
    "from sklearn.metrics import accuracy_score, recall_score, precision_score, f1_score, roc_auc_score, confusion_matrix\n",
    "\n",
    "# Biblioteca para realizar solicitações HTTP\n",
    "import requests\n",
    "\n",
    "# Biblioteca para trabalhar com dados financeiros\n",
    "import yfinance as yf\n",
    "\n",
    "# Configurações opcionais\n",
    "%matplotlib inline\n",
    "sns.set_style(\"whitegrid\")\n",
    "plt.rcParams['figure.figsize'] = (12, 6)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "38e2d54b",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Parâmetros e hiperparâmetros ajustáveis\n",
    "\n",
    "# Dados\n",
    "symbols = ['AAPL', 'MSFT', 'AMZN', 'TSLA', 'GOOGL']  # Lista de símbolos dos ativos subjacentes\n",
    "start_date = '2020-01-01'\n",
    "end_date = datetime.datetime.now().strftime(\"%Y-%m-%d\")  # Data final como a última data mais recente\n",
    "\n",
    "# Parâmetros de filtragem das opções\n",
    "min_days_to_expiration = 30  # Número mínimo de dias até a data de vencimento da opção\n",
    "max_days_to_expiration = 180  # Número máximo de dias até a data de vencimento da opção\n",
    "\n",
    "# Parâmetros do modelo de aprendizado de máquina\n",
    "test_size = 0.2  # Porcentagem dos dados usados para o conjunto de teste\n",
    "validation_size = 0.2  # Porcentagem dos dados usados para o conjunto de validação\n",
    "random_state = 42  # Semente para garantir a reprodutibilidade dos resultados\n",
    "\n",
    "# Hiperparâmetros de aprendizado de máquina\n",
    "dropout_rate = 0.5  # Taxa de dropout para redes neurais\n",
    "hidden_layers = [64, 32, 16]  # Número de neurônios nas camadas ocultas das redes neurais\n",
    "\n",
    "# Hiperparâmetros da rede neural\n",
    "activation_function = 'relu'  # Função de ativação para as camadas ocultas\n",
    "output_activation = 'sigmoid'  # Função de ativação para a camada de saída\n",
    "loss_function = 'binary_crossentropy'  # Função de perda\n",
    "optimizer = 'adam'  # Otimizador\n",
    "metrics = ['accuracy']  # Métricas de avaliação\n",
    "batch_size = 32  # Tamanho do lote para treinamento\n",
    "epochs = 100  # Número de épocas para treinamento\n",
    "early_stopping_patience = 10  # Número de épocas sem melhoria antes de parar o treinamento\n",
    "volatility_window = 21  # Janela de tempo para calcular a volatilidade histórica (em dias)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "2b861763",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "AAPL:\n",
      "Price Data:\n",
      "                                Open       High        Low      Close   \n",
      "Date                                                                    \n",
      "2020-01-02 00:00:00-05:00  72.444306  73.510531  72.187536  73.449394  \\\n",
      "2020-01-03 00:00:00-05:00  72.666848  73.505640  72.507895  72.735321   \n",
      "2020-01-06 00:00:00-05:00  71.845172  73.354016  71.590842  73.314888   \n",
      "2020-01-07 00:00:00-05:00  73.324665  73.583883  72.747540  72.970078   \n",
      "2020-01-08 00:00:00-05:00  72.669286  74.449580  72.669286  74.143898   \n",
      "\n",
      "                              Volume  Dividends  Stock Splits  \n",
      "Date                                                           \n",
      "2020-01-02 00:00:00-05:00  135480400        0.0           0.0  \n",
      "2020-01-03 00:00:00-05:00  146322800        0.0           0.0  \n",
      "2020-01-06 00:00:00-05:00  118387200        0.0           0.0  \n",
      "2020-01-07 00:00:00-05:00  108872000        0.0           0.0  \n",
      "2020-01-08 00:00:00-05:00  132079200        0.0           0.0  \n",
      "Calls Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice     bid   \n",
      "0  AAPL230512C00060000 2023-05-05 16:00:15+00:00    60.0     113.84  113.40  \\\n",
      "1  AAPL230512C00070000 2023-05-02 17:06:32+00:00    70.0      98.70  103.20   \n",
      "2  AAPL230512C00100000 2023-05-05 19:17:00+00:00   100.0      72.75   73.35   \n",
      "3  AAPL230512C00105000 2023-05-05 18:17:09+00:00   105.0      68.79   68.40   \n",
      "4  AAPL230512C00110000 2023-04-20 13:43:30+00:00   110.0      57.38   63.10   \n",
      "\n",
      "      ask    change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  113.55  0.000000       0.000000     3.0             2           0.500005  \\\n",
      "1  103.75  0.000000       0.000000     2.0             6           3.484376   \n",
      "2   73.60 -1.099999      -1.489504    15.0            16           1.851563   \n",
      "3   68.65  0.000000       0.000000     3.0             3           1.847657   \n",
      "4   64.50  0.000000       0.000000     NaN             1           1.929688   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0        True      REGULAR      USD  \n",
      "1        True      REGULAR      USD  \n",
      "2        True      REGULAR      USD  \n",
      "3        True      REGULAR      USD  \n",
      "4        True      REGULAR      USD  \n",
      "Puts Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice  bid   \n",
      "0  AAPL230512P00050000 2023-05-01 18:03:13+00:00    50.0       0.01  0.0  \\\n",
      "1  AAPL230512P00065000 2023-05-08 13:50:36+00:00    65.0       0.01  0.0   \n",
      "2  AAPL230512P00070000 2023-05-05 13:41:56+00:00    70.0       0.01  0.0   \n",
      "3  AAPL230512P00075000 2023-04-10 13:33:39+00:00    75.0       0.01  0.0   \n",
      "4  AAPL230512P00080000 2023-04-13 14:40:26+00:00    80.0       0.02  0.0   \n",
      "\n",
      "    ask  change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  0.01     0.0            0.0     7.0             9           3.250002  \\\n",
      "1  0.01     0.0            0.0     5.0            10           2.562504   \n",
      "2  0.01     0.0            0.0    14.0            14           2.375004   \n",
      "3  0.00     0.0            0.0    24.0            26           0.500005   \n",
      "4  0.01     0.0            0.0     NaN             1           2.062505   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0       False      REGULAR      USD  \n",
      "1       False      REGULAR      USD  \n",
      "2       False      REGULAR      USD  \n",
      "3       False      REGULAR      USD  \n",
      "4       False      REGULAR      USD  \n",
      "\n",
      "MSFT:\n",
      "Price Data:\n",
      "                                 Open        High         Low       Close   \n",
      "Date                                                                        \n",
      "2020-01-02 00:00:00-05:00  153.977437  155.868453  153.541051  155.761780  \\\n",
      "2020-01-03 00:00:00-05:00  153.531397  155.112085  153.279252  153.822311   \n",
      "2020-01-06 00:00:00-05:00  152.328863  154.287769  151.776096  154.219879   \n",
      "2020-01-07 00:00:00-05:00  154.501158  154.840563  152.561651  152.813782   \n",
      "2020-01-08 00:00:00-05:00  154.122900  155.936349  153.172546  155.247818   \n",
      "\n",
      "                             Volume  Dividends  Stock Splits  \n",
      "Date                                                          \n",
      "2020-01-02 00:00:00-05:00  22622100        0.0           0.0  \n",
      "2020-01-03 00:00:00-05:00  21116200        0.0           0.0  \n",
      "2020-01-06 00:00:00-05:00  20813700        0.0           0.0  \n",
      "2020-01-07 00:00:00-05:00  21634100        0.0           0.0  \n",
      "2020-01-08 00:00:00-05:00  27746500        0.0           0.0  \n",
      "Calls Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice     bid   \n",
      "0  MSFT230512C00150000 2023-05-08 19:16:37+00:00   150.0     158.45  158.30  \\\n",
      "1  MSFT230512C00160000 2023-04-24 19:05:53+00:00   160.0     121.98  148.25   \n",
      "2  MSFT230512C00200000 2023-04-25 13:44:25+00:00   200.0      82.05  107.15   \n",
      "3  MSFT230512C00210000 2023-04-19 17:20:29+00:00   210.0      79.02   97.90   \n",
      "4  MSFT230512C00215000 2023-05-08 16:43:47+00:00   215.0      92.22   93.05   \n",
      "\n",
      "      ask     change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  158.50  28.050003      21.510738     1.0             1           2.347660  \\\n",
      "1  148.50   0.000000       0.000000    22.0            22           2.152348   \n",
      "2  109.25   0.000000       0.000000     1.0             1           2.047856   \n",
      "3   98.80   0.000000       0.000000     NaN             1           1.620119   \n",
      "4   94.15  -2.159996      -2.288616     1.0             5           1.375003   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0        True      REGULAR      USD  \n",
      "1        True      REGULAR      USD  \n",
      "2        True      REGULAR      USD  \n",
      "3        True      REGULAR      USD  \n",
      "4        True      REGULAR      USD  \n",
      "Puts Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice  bid   \n",
      "0  MSFT230512P00150000 2023-05-01 18:06:38+00:00   150.0       0.01  0.0  \\\n",
      "1  MSFT230512P00160000 2023-04-21 18:00:49+00:00   160.0       0.01  0.0   \n",
      "2  MSFT230512P00170000 2023-05-03 19:52:00+00:00   170.0       0.01  0.0   \n",
      "3  MSFT230512P00185000 2023-04-25 16:54:58+00:00   185.0       0.01  0.0   \n",
      "4  MSFT230512P00190000 2023-04-21 16:42:40+00:00   190.0       0.03  0.0   \n",
      "\n",
      "    ask  change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  0.01     0.0            0.0    10.0           167           1.843751  \\\n",
      "1  0.01     0.0            0.0    13.0            26           1.687502   \n",
      "2  0.01     0.0            0.0     1.0             6           1.531252   \n",
      "3  0.01     0.0            0.0     1.0             0           1.312503   \n",
      "4  0.01     0.0            0.0     1.0             6           1.250004   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0       False      REGULAR      USD  \n",
      "1       False      REGULAR      USD  \n",
      "2       False      REGULAR      USD  \n",
      "3       False      REGULAR      USD  \n",
      "4       False      REGULAR      USD  \n",
      "\n",
      "AMZN:\n",
      "Price Data:\n",
      "                                Open       High        Low      Close   \n",
      "Date                                                                    \n",
      "2020-01-02 00:00:00-05:00  93.750000  94.900497  93.207497  94.900497  \\\n",
      "2020-01-03 00:00:00-05:00  93.224998  94.309998  93.224998  93.748497   \n",
      "2020-01-06 00:00:00-05:00  93.000000  95.184502  93.000000  95.143997   \n",
      "2020-01-07 00:00:00-05:00  95.224998  95.694504  94.601997  95.343002   \n",
      "2020-01-08 00:00:00-05:00  94.902000  95.550003  94.321999  94.598503   \n",
      "\n",
      "                             Volume  Dividends  Stock Splits  \n",
      "Date                                                          \n",
      "2020-01-02 00:00:00-05:00  80580000        0.0           0.0  \n",
      "2020-01-03 00:00:00-05:00  75288000        0.0           0.0  \n",
      "2020-01-06 00:00:00-05:00  81236000        0.0           0.0  \n",
      "2020-01-07 00:00:00-05:00  80898000        0.0           0.0  \n",
      "2020-01-08 00:00:00-05:00  70160000        0.0           0.0  \n",
      "Calls Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice    bid   \n",
      "0  AMZN230512C00055000 2023-05-08 14:02:41+00:00    55.0      50.60  50.70  \\\n",
      "1  AMZN230512C00060000 2023-05-04 17:36:42+00:00    60.0      44.84  45.75   \n",
      "2  AMZN230512C00065000 2023-04-19 16:33:23+00:00    65.0      40.05  40.70   \n",
      "3  AMZN230512C00070000 2023-04-24 16:33:12+00:00    70.0      36.47  35.70   \n",
      "4  AMZN230512C00075000 2023-04-28 14:48:54+00:00    75.0      30.75  30.70   \n",
      "\n",
      "     ask    change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  50.80  0.769997       1.545247    32.0             1           0.000010  \\\n",
      "1  45.90  0.000000       0.000000     1.0             4           2.078130   \n",
      "2  40.85  0.000000       0.000000     1.0            11           1.531252   \n",
      "3  36.00  0.000000       0.000000    10.0            11           1.312503   \n",
      "4  30.95  0.000000       0.000000     1.0            15           1.445315   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0        True      REGULAR      USD  \n",
      "1        True      REGULAR      USD  \n",
      "2        True      REGULAR      USD  \n",
      "3        True      REGULAR      USD  \n",
      "4        True      REGULAR      USD  \n",
      "Puts Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice  bid   \n",
      "0  AMZN230512P00055000 2023-05-05 13:59:26+00:00    55.0       0.01  0.0  \\\n",
      "1  AMZN230512P00060000 2023-05-05 15:22:49+00:00    60.0       0.01  0.0   \n",
      "2  AMZN230512P00065000 2023-05-04 13:40:49+00:00    65.0       0.01  0.0   \n",
      "3  AMZN230512P00070000 2023-05-08 14:56:53+00:00    70.0       0.01  0.0   \n",
      "4  AMZN230512P00075000 2023-05-05 19:47:00+00:00    75.0       0.01  0.0   \n",
      "\n",
      "    ask  change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  0.00     0.0            0.0     1.0         119.0           0.500005  \\\n",
      "1  0.01     0.0            0.0     2.0        7518.0           1.593752   \n",
      "2  0.01     0.0            0.0     1.0         370.0           1.375003   \n",
      "3  0.01     0.0            0.0   552.0         697.0           1.187504   \n",
      "4  0.01     0.0            0.0    11.0        1664.0           1.000005   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0       False      REGULAR      USD  \n",
      "1       False      REGULAR      USD  \n",
      "2       False      REGULAR      USD  \n",
      "3       False      REGULAR      USD  \n",
      "4       False      REGULAR      USD  \n",
      "\n",
      "TSLA:\n",
      "Price Data:\n",
      "                                Open       High        Low      Close   \n",
      "Date                                                                    \n",
      "2020-01-02 00:00:00-05:00  28.299999  28.713333  28.114000  28.684000  \\\n",
      "2020-01-03 00:00:00-05:00  29.366667  30.266666  29.128000  29.534000   \n",
      "2020-01-06 00:00:00-05:00  29.364668  30.104000  29.333332  30.102667   \n",
      "2020-01-07 00:00:00-05:00  30.760000  31.441999  30.224001  31.270666   \n",
      "2020-01-08 00:00:00-05:00  31.580000  33.232666  31.215334  32.809334   \n",
      "\n",
      "                              Volume  Dividends  Stock Splits  \n",
      "Date                                                           \n",
      "2020-01-02 00:00:00-05:00  142981500        0.0           0.0  \n",
      "2020-01-03 00:00:00-05:00  266677500        0.0           0.0  \n",
      "2020-01-06 00:00:00-05:00  151995000        0.0           0.0  \n",
      "2020-01-07 00:00:00-05:00  268231500        0.0           0.0  \n",
      "2020-01-08 00:00:00-05:00  467164500        0.0           0.0  \n",
      "Calls Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice     bid   \n",
      "0  TSLA230512C00020000 2023-04-28 15:47:40+00:00    20.0     142.24  151.45  \\\n",
      "1  TSLA230512C00030000 2023-04-25 13:36:32+00:00    30.0     129.00  141.40   \n",
      "2  TSLA230512C00040000 2023-04-28 16:05:58+00:00    40.0     122.99  131.50   \n",
      "3  TSLA230512C00050000 2023-05-08 14:39:37+00:00    50.0     119.47  121.40   \n",
      "4  TSLA230512C00060000 2023-05-05 19:12:34+00:00    60.0     110.19  111.10   \n",
      "\n",
      "      ask  change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  151.70    0.00       0.000000     2.0             2           5.625003  \\\n",
      "1  141.65    0.00       0.000000     1.0            12           5.843753   \n",
      "2  131.70    0.00       0.000000     1.0             1           4.406254   \n",
      "3  121.80    6.93       6.157811    81.0            81           3.750001   \n",
      "4  111.65    0.00       0.000000     2.0             2           3.570314   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0        True      REGULAR      USD  \n",
      "1        True      REGULAR      USD  \n",
      "2        True      REGULAR      USD  \n",
      "3        True      REGULAR      USD  \n",
      "4        True      REGULAR      USD  \n",
      "Puts Data:\n",
      "        contractSymbol             lastTradeDate  strike  lastPrice  bid   \n",
      "0  TSLA230512P00020000 2023-05-08 13:30:02+00:00    20.0       0.01  0.0  \\\n",
      "1  TSLA230512P00030000 2023-05-05 15:25:24+00:00    30.0       0.01  0.0   \n",
      "2  TSLA230512P00040000 2023-04-19 15:44:25+00:00    40.0       0.02  0.0   \n",
      "3  TSLA230512P00050000 2023-05-08 13:51:51+00:00    50.0       0.01  0.0   \n",
      "4  TSLA230512P00060000 2023-05-08 13:50:34+00:00    60.0       0.01  0.0   \n",
      "\n",
      "    ask  change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  0.01     0.0            0.0    35.0         430.0           5.625003  \\\n",
      "1  0.00     0.0            0.0     1.0           2.0           0.500005   \n",
      "2  0.00     0.0            0.0     NaN           1.0           0.500005   \n",
      "3  0.00     0.0            0.0    10.0         419.0           0.500005   \n",
      "4  0.00     0.0            0.0     3.0         172.0           0.500005   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0       False      REGULAR      USD  \n",
      "1       False      REGULAR      USD  \n",
      "2       False      REGULAR      USD  \n",
      "3       False      REGULAR      USD  \n",
      "4       False      REGULAR      USD  \n",
      "\n",
      "GOOGL:\n",
      "Price Data:\n",
      "                                Open       High        Low      Close   \n",
      "Date                                                                    \n",
      "2020-01-02 00:00:00-05:00  67.420502  68.433998  67.324501  68.433998  \\\n",
      "2020-01-03 00:00:00-05:00  67.400002  68.687500  67.365997  68.075996   \n",
      "2020-01-06 00:00:00-05:00  67.581497  69.916000  67.550003  69.890503   \n",
      "2020-01-07 00:00:00-05:00  70.023003  70.175003  69.578003  69.755501   \n",
      "2020-01-08 00:00:00-05:00  69.740997  70.592499  69.631500  70.251999   \n",
      "\n",
      "                             Volume  Dividends  Stock Splits  \n",
      "Date                                                          \n",
      "2020-01-02 00:00:00-05:00  27278000        0.0           0.0  \n",
      "2020-01-03 00:00:00-05:00  23408000        0.0           0.0  \n",
      "2020-01-06 00:00:00-05:00  46768000        0.0           0.0  \n",
      "2020-01-07 00:00:00-05:00  34330000        0.0           0.0  \n",
      "2020-01-08 00:00:00-05:00  35314000        0.0           0.0  \n",
      "Calls Data:\n",
      "         contractSymbol             lastTradeDate  strike  lastPrice    bid   \n",
      "0  GOOGL230512C00050000 2023-05-08 17:40:40+00:00    50.0      57.75  57.50  \\\n",
      "1  GOOGL230512C00070000 2023-05-04 19:15:46+00:00    70.0      34.84  37.40   \n",
      "2  GOOGL230512C00075000 2023-05-08 13:40:12+00:00    75.0      31.21  32.20   \n",
      "3  GOOGL230512C00080000 2023-05-05 14:28:06+00:00    80.0      24.80  27.45   \n",
      "4  GOOGL230512C00082000 2023-05-08 15:11:04+00:00    82.0      24.65  25.45   \n",
      "\n",
      "     ask    change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  57.60  2.490002       4.505975     3.0            20           0.000010  \\\n",
      "1  37.70  0.000000       0.000000     NaN             5           0.000010   \n",
      "2  32.80  1.139999       3.791152     2.0             4           0.000010   \n",
      "3  28.30  0.000000       0.000000     5.0            83           1.093755   \n",
      "4  26.05  0.900000       3.789472     1.0             2           1.312503   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0        True      REGULAR      USD  \n",
      "1        True      REGULAR      USD  \n",
      "2        True      REGULAR      USD  \n",
      "3        True      REGULAR      USD  \n",
      "4        True      REGULAR      USD  \n",
      "Puts Data:\n",
      "         contractSymbol             lastTradeDate  strike  lastPrice  bid   \n",
      "0  GOOGL230512P00050000 2023-05-01 18:09:05+00:00    50.0       0.01  0.0  \\\n",
      "1  GOOGL230512P00055000 2023-04-18 19:35:42+00:00    55.0       0.01  0.0   \n",
      "2  GOOGL230512P00060000 2023-04-25 17:35:42+00:00    60.0       0.01  0.0   \n",
      "3  GOOGL230512P00065000 2023-05-08 19:16:38+00:00    65.0       0.01  0.0   \n",
      "4  GOOGL230512P00070000 2023-04-27 13:50:28+00:00    70.0       0.01  0.0   \n",
      "\n",
      "    ask  change  percentChange  volume  openInterest  impliedVolatility   \n",
      "0  0.01    0.00            0.0     NaN          11.0           2.125005  \\\n",
      "1  0.01    0.00            0.0     NaN           2.0           1.875001   \n",
      "2  0.02    0.00            0.0     2.0          12.0           1.750001   \n",
      "3  0.02   -0.01          -50.0     5.0           6.0           1.531252   \n",
      "4  0.01    0.00            0.0     3.0          94.0           1.250004   \n",
      "\n",
      "   inTheMoney contractSize currency  \n",
      "0       False      REGULAR      USD  \n",
      "1       False      REGULAR      USD  \n",
      "2       False      REGULAR      USD  \n",
      "3       False      REGULAR      USD  \n",
      "4       False      REGULAR      USD  \n",
      "\n",
      "AAPL     131.490191\n",
      "MSFT     244.530986\n",
      "AMZN     137.967868\n",
      "TSLA     203.092814\n",
      "GOOGL    103.685983\n",
      "dtype: float64\n"
     ]
    }
   ],
   "source": [
    "# Obtendo e salvando os dados\n",
    "def get_historical_data(symbol, start_date, end_date):\n",
    "    ticker = yf.Ticker(symbol)\n",
    "\n",
    "    # Obter dados históricos de preços do ativo subjacente\n",
    "    historical_price_data = ticker.history(start=start_date, end=end_date)\n",
    "    \n",
    "    # Obter dados das opções\n",
    "    calls_data = []\n",
    "    puts_data = []\n",
    "\n",
    "    for expiration_date in ticker.options:\n",
    "        options_data = ticker.option_chain(expiration_date)\n",
    "        calls_data.append(options_data.calls)\n",
    "        puts_data.append(options_data.puts)\n",
    "\n",
    "    if calls_data:\n",
    "        calls_data = pd.concat(calls_data)\n",
    "    else:\n",
    "        calls_data = pd.DataFrame()\n",
    "\n",
    "    if puts_data:\n",
    "        puts_data = pd.concat(puts_data)\n",
    "    else:\n",
    "        puts_data = pd.DataFrame()\n",
    "\n",
    "    return historical_price_data, calls_data, puts_data\n",
    "\n",
    "historical_data = {}\n",
    "\n",
    "for symbol in symbols:\n",
    "    price_data, calls_data, puts_data = get_historical_data(symbol, start_date, end_date)\n",
    "    historical_data[symbol] = {\"price_data\": price_data, \"calls_data\": calls_data, \"puts_data\": puts_data}\n",
    "\n",
    "for symbol, data in historical_data.items():\n",
    "    print(f\"{symbol}:\\nPrice Data:\\n{data['price_data'].head()}\\nCalls Data:\\n{data['calls_data'].head()}\\nPuts Data:\\n{data['puts_data'].head()}\\n\")\n",
    "\n",
    "# Lista de DataFrames com os dados de preço das ações\n",
    "price_data_list = [historical_data[symbol][\"price_data\"] for symbol in symbols]\n",
    "\n",
    "# Extrair apenas os preços de fechamento (Close) de cada DataFrame\n",
    "close_prices_list = [price_data[\"Close\"] for price_data in price_data_list]\n",
    "\n",
    "# Concatenar todos os preços de fechamento em um único DataFrame\n",
    "close_prices_df = pd.concat(close_prices_list, axis=1)\n",
    "\n",
    "# Nomear as colunas do DataFrame com os símbolos das ações\n",
    "close_prices_df.columns = symbols\n",
    "\n",
    "# Calcular a média dos preços de fechamento ao longo do período\n",
    "average_close_prices = close_prices_df.mean()\n",
    "\n",
    "# Exibir a média dos preços de fechamento\n",
    "print(average_close_prices)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "d2db3947",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Função para processar, limpar e dividir os dados\n",
    "def preprocess_data(historical_data, min_days_to_expiration, max_days_to_expiration, test_size, validation_size, random_state):\n",
    "    combined_data = []\n",
    "    \n",
    "    for symbol, data in historical_data.items():\n",
    "        price_data = data['price_data']\n",
    "        calls_data = data['calls_data']\n",
    "        puts_data = data['puts_data']\n",
    "\n",
    "        # Calcular a data de vencimento das opções com base no 'contractSymbol'\n",
    "        calls_data['expiration'] = pd.to_datetime(calls_data['contractSymbol'].str.extract('(\\d{6})')[0], format='%y%m%d')\n",
    "        puts_data['expiration'] = pd.to_datetime(puts_data['contractSymbol'].str.extract('(\\d{6})')[0], format='%y%m%d')\n",
    "\n",
    "        # Filtrar opções com base no intervalo de tempo até a data de vencimento\n",
    "        min_date = datetime.datetime.now() + datetime.timedelta(days=min_days_to_expiration)\n",
    "        max_date = datetime.datetime.now() + datetime.timedelta(days=max_days_to_expiration)\n",
    "\n",
    "        calls_data = calls_data[(calls_data['expiration'] >= min_date) & (calls_data['expiration'] <= max_date)]\n",
    "        puts_data = puts_data[(puts_data['expiration'] >= min_date) & (puts_data['expiration'] <= max_date)]\n",
    "\n",
    "        # Adicionar informações do ativo subjacente\n",
    "        calls_data['underlying_price'] = calls_data['contractSymbol'].apply(lambda x: price_data.loc[x.split('_')[1], 'Close'])\n",
    "        puts_data['underlying_price'] = puts_data['contractSymbol'].apply(lambda x: price_data.loc[x.split('_')[1], 'Close'])\n",
    "\n",
    "        # Marcar dados como chamadas ou puts\n",
    "        calls_data['option_type'] = 'call'\n",
    "        puts_data['option_type'] = 'put'\n",
    "\n",
    "        # Concatenar chamadas e puts\n",
    "        combined_data.append(pd.concat([calls_data, puts_data]))\n",
    "\n",
    "    # Concatenar dados de todos os símbolos\n",
    "    combined_data = pd.concat(combined_data)\n",
    "\n",
    "    # Limpar dados (remover linhas com valores ausentes)\n",
    "    combined_data.dropna(inplace=True)\n",
    "\n",
    "    # Dividir dados em conjuntos de treinamento, validação e teste\n",
    "    train_data, test_data = train_test_split(combined_data, test_size=test_size, random_state=random_state)\n",
    "    train_data, validation_data = train_test_split(train_data, test_size=validation_size, random_state=random_state)\n",
    "\n",
    "    return train_data, validation_data, test_data\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "44d2aeb5",
   "metadata": {},
   "outputs": [
    {
     "ename": "IndexError",
     "evalue": "list index out of range",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mIndexError\u001b[0m                                Traceback (most recent call last)",
      "Cell \u001b[1;32mIn[5], line 3\u001b[0m\n\u001b[0;32m      1\u001b[0m \u001b[38;5;66;03m# Função para calcular a volatilidade histórica\u001b[39;00m\n\u001b[1;32m----> 3\u001b[0m train_data, validation_data, test_data \u001b[38;5;241m=\u001b[39m \u001b[43mpreprocess_data\u001b[49m\u001b[43m(\u001b[49m\n\u001b[0;32m      4\u001b[0m \u001b[43m    \u001b[49m\u001b[43mhistorical_data\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m      5\u001b[0m \u001b[43m    \u001b[49m\u001b[43mmin_days_to_expiration\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m      6\u001b[0m \u001b[43m    \u001b[49m\u001b[43mmax_days_to_expiration\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m      7\u001b[0m \u001b[43m    \u001b[49m\u001b[43mtest_size\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m      8\u001b[0m \u001b[43m    \u001b[49m\u001b[43mvalidation_size\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m      9\u001b[0m \u001b[43m    \u001b[49m\u001b[43mrandom_state\u001b[49m\n\u001b[0;32m     10\u001b[0m \u001b[43m)\u001b[49m\n\u001b[0;32m     12\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mcalculate_historical_volatility\u001b[39m(price_data, window):\n\u001b[0;32m     13\u001b[0m     log_returns \u001b[38;5;241m=\u001b[39m np\u001b[38;5;241m.\u001b[39mlog(price_data \u001b[38;5;241m/\u001b[39m price_data\u001b[38;5;241m.\u001b[39mshift(\u001b[38;5;241m1\u001b[39m))\n",
      "Cell \u001b[1;32mIn[4], line 22\u001b[0m, in \u001b[0;36mpreprocess_data\u001b[1;34m(historical_data, min_days_to_expiration, max_days_to_expiration, test_size, validation_size, random_state)\u001b[0m\n\u001b[0;32m     19\u001b[0m puts_data \u001b[38;5;241m=\u001b[39m puts_data[(puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mexpiration\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m>\u001b[39m\u001b[38;5;241m=\u001b[39m min_date) \u001b[38;5;241m&\u001b[39m (puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mexpiration\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m<\u001b[39m\u001b[38;5;241m=\u001b[39m max_date)]\n\u001b[0;32m     21\u001b[0m \u001b[38;5;66;03m# Adicionar informações do ativo subjacente\u001b[39;00m\n\u001b[1;32m---> 22\u001b[0m calls_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124munderlying_price\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m=\u001b[39m \u001b[43mcalls_data\u001b[49m\u001b[43m[\u001b[49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43mcontractSymbol\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m]\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mapply\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43;01mlambda\u001b[39;49;00m\u001b[43m \u001b[49m\u001b[43mx\u001b[49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[43mprice_data\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mloc\u001b[49m\u001b[43m[\u001b[49m\u001b[43mx\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43msplit\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43m_\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m)\u001b[49m\u001b[43m[\u001b[49m\u001b[38;5;241;43m1\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43mClose\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m     23\u001b[0m puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124munderlying_price\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m=\u001b[39m puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mcontractSymbol\u001b[39m\u001b[38;5;124m'\u001b[39m]\u001b[38;5;241m.\u001b[39mapply(\u001b[38;5;28;01mlambda\u001b[39;00m x: price_data\u001b[38;5;241m.\u001b[39mloc[x\u001b[38;5;241m.\u001b[39msplit(\u001b[38;5;124m'\u001b[39m\u001b[38;5;124m_\u001b[39m\u001b[38;5;124m'\u001b[39m)[\u001b[38;5;241m1\u001b[39m], \u001b[38;5;124m'\u001b[39m\u001b[38;5;124mClose\u001b[39m\u001b[38;5;124m'\u001b[39m])\n\u001b[0;32m     25\u001b[0m \u001b[38;5;66;03m# Marcar dados como chamadas ou puts\u001b[39;00m\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\site-packages\\pandas\\core\\series.py:4631\u001b[0m, in \u001b[0;36mSeries.apply\u001b[1;34m(self, func, convert_dtype, args, **kwargs)\u001b[0m\n\u001b[0;32m   4521\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mapply\u001b[39m(\n\u001b[0;32m   4522\u001b[0m     \u001b[38;5;28mself\u001b[39m,\n\u001b[0;32m   4523\u001b[0m     func: AggFuncType,\n\u001b[1;32m   (...)\u001b[0m\n\u001b[0;32m   4526\u001b[0m     \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39mkwargs,\n\u001b[0;32m   4527\u001b[0m ) \u001b[38;5;241m-\u001b[39m\u001b[38;5;241m>\u001b[39m DataFrame \u001b[38;5;241m|\u001b[39m Series:\n\u001b[0;32m   4528\u001b[0m \u001b[38;5;250m    \u001b[39m\u001b[38;5;124;03m\"\"\"\u001b[39;00m\n\u001b[0;32m   4529\u001b[0m \u001b[38;5;124;03m    Invoke function on values of Series.\u001b[39;00m\n\u001b[0;32m   4530\u001b[0m \n\u001b[1;32m   (...)\u001b[0m\n\u001b[0;32m   4629\u001b[0m \u001b[38;5;124;03m    dtype: float64\u001b[39;00m\n\u001b[0;32m   4630\u001b[0m \u001b[38;5;124;03m    \"\"\"\u001b[39;00m\n\u001b[1;32m-> 4631\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mSeriesApply\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mfunc\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mconvert_dtype\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43margs\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mkwargs\u001b[49m\u001b[43m)\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mapply\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\site-packages\\pandas\\core\\apply.py:1025\u001b[0m, in \u001b[0;36mSeriesApply.apply\u001b[1;34m(self)\u001b[0m\n\u001b[0;32m   1022\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mapply_str()\n\u001b[0;32m   1024\u001b[0m \u001b[38;5;66;03m# self.f is Callable\u001b[39;00m\n\u001b[1;32m-> 1025\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mapply_standard\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\site-packages\\pandas\\core\\apply.py:1076\u001b[0m, in \u001b[0;36mSeriesApply.apply_standard\u001b[1;34m(self)\u001b[0m\n\u001b[0;32m   1074\u001b[0m     \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[0;32m   1075\u001b[0m         values \u001b[38;5;241m=\u001b[39m obj\u001b[38;5;241m.\u001b[39mastype(\u001b[38;5;28mobject\u001b[39m)\u001b[38;5;241m.\u001b[39m_values\n\u001b[1;32m-> 1076\u001b[0m         mapped \u001b[38;5;241m=\u001b[39m \u001b[43mlib\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mmap_infer\u001b[49m\u001b[43m(\u001b[49m\n\u001b[0;32m   1077\u001b[0m \u001b[43m            \u001b[49m\u001b[43mvalues\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m   1078\u001b[0m \u001b[43m            \u001b[49m\u001b[43mf\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m   1079\u001b[0m \u001b[43m            \u001b[49m\u001b[43mconvert\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mconvert_dtype\u001b[49m\u001b[43m,\u001b[49m\n\u001b[0;32m   1080\u001b[0m \u001b[43m        \u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m   1082\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mlen\u001b[39m(mapped) \u001b[38;5;129;01mand\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(mapped[\u001b[38;5;241m0\u001b[39m], ABCSeries):\n\u001b[0;32m   1083\u001b[0m     \u001b[38;5;66;03m# GH#43986 Need to do list(mapped) in order to get treated as nested\u001b[39;00m\n\u001b[0;32m   1084\u001b[0m     \u001b[38;5;66;03m#  See also GH#25959 regarding EA support\u001b[39;00m\n\u001b[0;32m   1085\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m obj\u001b[38;5;241m.\u001b[39m_constructor_expanddim(\u001b[38;5;28mlist\u001b[39m(mapped), index\u001b[38;5;241m=\u001b[39mobj\u001b[38;5;241m.\u001b[39mindex)\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\site-packages\\pandas\\_libs\\lib.pyx:2834\u001b[0m, in \u001b[0;36mpandas._libs.lib.map_infer\u001b[1;34m()\u001b[0m\n",
      "Cell \u001b[1;32mIn[4], line 22\u001b[0m, in \u001b[0;36mpreprocess_data.<locals>.<lambda>\u001b[1;34m(x)\u001b[0m\n\u001b[0;32m     19\u001b[0m puts_data \u001b[38;5;241m=\u001b[39m puts_data[(puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mexpiration\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m>\u001b[39m\u001b[38;5;241m=\u001b[39m min_date) \u001b[38;5;241m&\u001b[39m (puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mexpiration\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m<\u001b[39m\u001b[38;5;241m=\u001b[39m max_date)]\n\u001b[0;32m     21\u001b[0m \u001b[38;5;66;03m# Adicionar informações do ativo subjacente\u001b[39;00m\n\u001b[1;32m---> 22\u001b[0m calls_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124munderlying_price\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m=\u001b[39m calls_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mcontractSymbol\u001b[39m\u001b[38;5;124m'\u001b[39m]\u001b[38;5;241m.\u001b[39mapply(\u001b[38;5;28;01mlambda\u001b[39;00m x: price_data\u001b[38;5;241m.\u001b[39mloc[\u001b[43mx\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43msplit\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43m_\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m)\u001b[49m\u001b[43m[\u001b[49m\u001b[38;5;241;43m1\u001b[39;49m\u001b[43m]\u001b[49m, \u001b[38;5;124m'\u001b[39m\u001b[38;5;124mClose\u001b[39m\u001b[38;5;124m'\u001b[39m])\n\u001b[0;32m     23\u001b[0m puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124munderlying_price\u001b[39m\u001b[38;5;124m'\u001b[39m] \u001b[38;5;241m=\u001b[39m puts_data[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mcontractSymbol\u001b[39m\u001b[38;5;124m'\u001b[39m]\u001b[38;5;241m.\u001b[39mapply(\u001b[38;5;28;01mlambda\u001b[39;00m x: price_data\u001b[38;5;241m.\u001b[39mloc[x\u001b[38;5;241m.\u001b[39msplit(\u001b[38;5;124m'\u001b[39m\u001b[38;5;124m_\u001b[39m\u001b[38;5;124m'\u001b[39m)[\u001b[38;5;241m1\u001b[39m], \u001b[38;5;124m'\u001b[39m\u001b[38;5;124mClose\u001b[39m\u001b[38;5;124m'\u001b[39m])\n\u001b[0;32m     25\u001b[0m \u001b[38;5;66;03m# Marcar dados como chamadas ou puts\u001b[39;00m\n",
      "\u001b[1;31mIndexError\u001b[0m: list index out of range"
     ]
    }
   ],
   "source": [
    "# Função para calcular a volatilidade histórica\n",
    "\n",
    "train_data, validation_data, test_data = preprocess_data(\n",
    "    historical_data,\n",
    "    min_days_to_expiration,\n",
    "    max_days_to_expiration,\n",
    "    test_size,\n",
    "    validation_size,\n",
    "    random_state\n",
    ")\n",
    "\n",
    "def calculate_historical_volatility(price_data, window):\n",
    "    log_returns = np.log(price_data / price_data.shift(1))\n",
    "    historical_volatility = log_returns.rolling(window=window).std() * np.sqrt(252)\n",
    "    return historical_volatility\n",
    "\n",
    "# Calcular a volatilidade histórica para cada ativo subjacente\n",
    "historical_volatility = {}\n",
    "for symbol, data in historical_data.items():\n",
    "    historical_volatility[symbol] = calculate_historical_volatility(data['price_data']['Close'], window=volatility_window)\n",
    "\n",
    "# Função para calcular a volatilidade implícita\n",
    "def calculate_implied_volatility(option_data, option_type):\n",
    "    option_data['IV'] = option_data.apply(lambda row: iv.implied_volatility(row['lastPrice'], row['underlying_price'], row['strike'], days_to_expiration(row['expiration']), row['lastPrice'], option_type), axis=1)\n",
    "    return option_data\n",
    "\n",
    "# Calcular a volatilidade implícita para os conjuntos de dados de treinamento, validação e teste\n",
    "train_data = calculate_implied_volatility(train_data, option_type='call')\n",
    "validation_data = calculate_implied_volatility(validation_data, option_type='call')\n",
    "test_data = calculate_implied_volatility(test_data, option_type='call')\n",
    "\n",
    "# Função para filtrar opções com base em critérios específicos\n",
    "def filter_options(data, historical_volatility, min_iv, max_iv):\n",
    "    data = data[data['IV'] >= min_iv * historical_volatility]\n",
    "    data = data[data['IV'] <= max_iv * historical_volatility]\n",
    "    return data\n",
    "\n",
    "# Filtrar opções com base na volatilidade implícita e na volatilidade histórica\n",
    "train_data_filtered = filter_options(train_data, historical_volatility, min_iv_multiplier, max_iv_multiplier)\n",
    "validation_data_filtered = filter_options(validation_data, historical_volatility, min_iv_multiplier, max_iv_multiplier)\n",
    "test_data_filtered = filter_options(test_data, historical_volatility, min_iv_multiplier, max_iv_multiplier)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e3470ed5",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Função para treinar e validar o modelo de aprendizado de máquina\n",
    "def train_and_validate_model(model, train_data, validation_data, batch_size, epochs, early_stopping_patience):\n",
    "    # Implementar aqui o treinamento e validação do modelo de aprendizado de máquina\n",
    "\n",
    "    return history\n",
    "\n",
    "# Treinar e validar o modelo de aprendizado de máquina\n",
    "history = train_and_validate_model(model, train_data, validation_data, batch_size, epochs, early_stopping_patience)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0e097e22",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Função para avaliar o desempenho do modelo de aprendizado de máquina\n",
    "def evaluate_model_performance(model, test_data):\n",
    "    # Implementar aqui a avaliação do desempenho do modelo de aprendizado de máquina\n",
    "\n",
    "    return evaluation_metrics\n",
    "\n",
    "# Avaliar o desempenho do modelo de aprendizado de máquina\n",
    "evaluation_metrics = evaluate_model_performance(model, test_data)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0aaff108",
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "# Função para implementar o modelo em um ambiente de negociação real e monitorar seu desempenho\n",
    "def implement_and_monitor_model(model, trading_data):\n",
    "    # Implementar aqui a implementação do modelo em um ambiente de negociação real e o monitoramento de seu desempenho\n",
    "\n",
    "    return trading_performance\n",
    "\n",
    "# Implementar o modelo em um ambiente de negociação real e monitorar seu desempenho\n",
    "trading_performance = implement_and_monitor_model(model, trading_data)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d9ffc270",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
